{% extends 'base.html' %}
{% block title %}AI Chatbot - College AI{% endblock %}

{% block extra_css %}
<style>
    body { overflow: hidden; }

    /* ── Welcome Tip ────────────────────────────────────────────── */
    .welcome-tip {
        margin-top: 1.4rem;
        font-size: 0.84rem;
        color: #6c757d;
        background: #f4f6ff;
        border: 1.5px solid #dde3f7;
        border-radius: 12px;
        padding: 0.65rem 1.1rem;
        display: inline-block;
        max-width: 420px;
    }

    /* ── Per-message tip ────────────────────────────────────────── */
    .chat-tip {
        font-size: 0.72rem;
        color: #b0bbd6;
        padding: 0 0.5rem 0.6rem 0.5rem;
        user-select: none;
    }
    .tip-cmd {
        color: #4361ee;
        font-weight: 700;
        cursor: pointer;
        font-family: monospace;
        font-size: 0.78rem;
    }
    .tip-cmd:hover { text-decoration: underline; }

    /* ── Services Card (appears in chat) ────────────────────────── */
    .services-card {
        background: linear-gradient(135deg, #f2f5ff 0%, #eaf0ff 100%);
        border: 1.5px solid #c9d4f5;
        border-radius: 16px;
        padding: 1.1rem 1.2rem 1rem;
        max-width: 360px;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }
    .services-card-icon { font-size: 1.5rem; line-height: 1; }
    .services-card-body strong { font-size: 0.97rem; color: #1a1a2e; }
    .services-card-body p {
        font-size: 0.82rem;
        color: #555;
        margin: 0.2rem 0 0.1rem;
        line-height: 1.4;
    }
    .btn-view-options {
        background: #4361ee;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.18s, transform 0.12s;
        width: 100%;
        margin-top: 0.35rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    .btn-view-options:hover { background: #3451d1; transform: translateY(-1px); }
    .btn-view-options:active { transform: translateY(0); }

    /* ── Services Modal Overlay ─────────────────────────────────── */
    .services-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 20, 50, 0.52);
        z-index: 9999;
        align-items: flex-end;
        justify-content: center;
        backdrop-filter: blur(2px);
    }
    .services-modal-overlay.open { display: flex; }

    /* ── Modal Panel ────────────────────────────────────────────── */
    .services-modal {
        background: #fff;
        width: 100%;
        max-width: 660px;
        max-height: 86vh;
        border-radius: 22px 22px 0 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: svc-slide-up 0.28s cubic-bezier(.22,.68,0,1.2) both;
        box-shadow: 0 -8px 40px rgba(67,97,238,0.13);
    }
    @keyframes svc-slide-up {
        from { transform: translateY(60px); opacity: 0; }
        to   { transform: translateY(0);    opacity: 1; }
    }

    /* ── Modal Header ───────────────────────────────────────────── */
    .services-modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 1.25rem 1.4rem 0.9rem;
        border-bottom: 1px solid #f0f0f4;
        flex-shrink: 0;
    }
    .services-modal-header h5 {
        font-size: 1.05rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 0.1rem;
    }
    .services-modal-header small { color: #8a93b2; font-size: 0.8rem; }
    .services-modal-close {
        background: #f0f2f7;
        border: none;
        border-radius: 50%;
        width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        color: #555;
        font-size: 0.9rem;
        transition: background 0.15s;
        margin-top: -2px;
    }
    .services-modal-close:hover { background: #e0e3ef; color: #222; }

    /* ── Search Bar ─────────────────────────────────────────────── */
    .services-modal-search {
        position: relative;
        padding: 0.8rem 1.2rem;
        border-bottom: 1px solid #f0f0f4;
        flex-shrink: 0;
    }
    .services-search-icon {
        position: absolute;
        left: 2rem;
        top: 50%; transform: translateY(-50%);
        color: #bbb; font-size: 0.88rem; pointer-events: none;
    }
    .services-modal-search input {
        width: 100%;
        border: 1.5px solid #e2e6f3;
        border-radius: 12px;
        padding: 0.6rem 0.9rem 0.6rem 2.4rem;
        font-size: 0.9rem;
        outline: none;
        background: #f7f8ff;
        color: #1a1a2e;
        transition: border-color 0.18s, background 0.18s;
    }
    .services-modal-search input:focus {
        border-color: #4361ee;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(67,97,238,0.1);
    }
    .services-modal-search input::placeholder { color: #b0b8d4; }

    /* ── Modal Body ─────────────────────────────────────────────── */
    .services-modal-body {
        overflow-y: auto;
        padding: 0.8rem 1.2rem 0.6rem;
        flex: 1;
        overscroll-behavior: contain;
    }
    .services-modal-body::-webkit-scrollbar { width: 5px; }
    .services-modal-body::-webkit-scrollbar-track { background: transparent; }
    .services-modal-body::-webkit-scrollbar-thumb { background: #dde0ef; border-radius: 10px; }

    /* ── Question Categories ─────────────────────────────────────── */
    .services-category { margin-bottom: 1.1rem; }
    .services-category-title {
        font-size: 0.73rem;
        font-weight: 700;
        color: #8a93b2;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        margin-bottom: 0.5rem;
        padding-left: 0.1rem;
    }
    .services-questions-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
    }
    .services-q-btn {
        background: #f4f6ff;
        border: 1.5px solid #dde3f5;
        border-radius: 22px;
        padding: 0.38rem 0.9rem;
        font-size: 0.8rem;
        color: #2d3a6e;
        cursor: pointer;
        transition: all 0.15s;
        text-align: left;
        line-height: 1.45;
        font-family: inherit;
    }
    .services-q-btn:hover {
        background: #4361ee;
        color: #fff;
        border-color: #4361ee;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(67,97,238,0.2);
    }
    .services-q-btn:active { transform: translateY(0); }

    /* ── No Results ─────────────────────────────────────────────── */
    .services-no-results {
        text-align: center;
        color: #9ea8c4;
        padding: 2.5rem 1rem;
        font-size: 0.88rem;
        line-height: 1.7;
    }

    /* ── Modal Footer ───────────────────────────────────────────── */
    .services-modal-footer {
        padding: 0.65rem 1.4rem;
        border-top: 1px solid #f0f0f4;
        background: #fafbff;
        flex-shrink: 0;
    }

    /* ── Desktop: centered modal ────────────────────────────────── */
    @media (min-width: 640px) {
        .services-modal-overlay { align-items: center; }
        .services-modal {
            border-radius: 20px;
            max-height: 82vh;
            margin-bottom: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Mobile sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Mobile sidebar toggle -->
<button class="sidebar-toggle" id="sidebarToggle">
    <i class="bi bi-chat-left-text"></i>
</button>

<div class="chat-container">
    <!-- Sidebar -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <button class="btn btn-primary" id="newChatBtn">
                <i class="bi bi-plus-lg me-1"></i> New Chat
            </button>
        </div>
        <div class="chat-list" id="chatList">
            {% for chat in chat_list %}
            <div class="chat-list-item" data-chat-id="{{ chat.id }}">
                <span class="chat-title">
                    <i class="bi bi-chat-dots me-2"></i>{{ chat.title }}
                </span>
                <span class="chat-delete" data-chat-id="{{ chat.id }}">
                    <i class="bi bi-trash"></i>
                </span>
            </div>
            {% endfor %}
            {% if not chat_list %}
            <div class="text-center py-4 text-muted small">
                <i class="bi bi-chat-square-text d-block mb-2" style="font-size:1.5rem;opacity:0.4;"></i>
                No chats yet. Start a new conversation!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages populate here via JS -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <span></span><span></span><span></span>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <div class="chat-input-group">
                <textarea id="messageInput" rows="1"
                          placeholder="Ask anything, or type /services to browse all topics…"
                          aria-label="Type your message"></textarea>
                <button class="btn-send" id="sendBtn" aria-label="Send message">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ── Services / Questions Modal ────────────────────────────────────────── -->
<div id="servicesModal"
     class="services-modal-overlay"
     onclick="closeServicesModalOutside(event)">
    <div class="services-modal">

        <!-- Header -->
        <div class="services-modal-header">
            <div>
                <h5><i class="bi bi-grid-3x3-gap me-2"></i>Browse All Topics</h5>
                <small>Click any question to get an instant answer</small>
            </div>
            <button class="services-modal-close" onclick="closeServicesModal()" aria-label="Close">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Search -->
        <div class="services-modal-search">
            <i class="bi bi-search services-search-icon"></i>
            <input type="text"
                   id="servicesSearch"
                   placeholder="Search questions… e.g. attendance, cgpa, fees"
                   oninput="renderServicesBody(this.value)"
                   autocomplete="off"
                   spellcheck="false">
        </div>

        <!-- Question List -->
        <div class="services-modal-body" id="servicesBody">
            <!-- rendered by JS -->
        </div>

        <!-- Footer -->
        <div class="services-modal-footer">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                You can also type <strong>/services</strong> or <strong>/questions</strong>
                anytime in the chat to open this panel.
            </small>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
