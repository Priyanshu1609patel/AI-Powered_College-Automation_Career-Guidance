{% extends 'base.html' %}
{% block title %}Job Alerts - Career Guidance AI{% endblock %}
{% block content %}
<div class="page-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="section-title mb-0"><i class="bi bi-bell me-2"></i>Job Alerts</h4>
        <a href="{{ url_for('jobs') }}" class="btn btn-career-outline btn-sm"><i class="bi bi-arrow-left me-1"></i>Job Board</a>
    </div>

    <!-- Create Alert -->
    <div class="stat-card mb-4">
        <h6 class="fw-bold mb-3" style="color: var(--dark);"><i class="bi bi-plus-circle me-1" style="color: var(--primary);"></i>Create New Job Alert</h6>
        <form method="POST" action="{{ url_for('job_alerts') }}">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" name="keyword" id="alert-keyword" placeholder="Keyword (e.g. Python, Data Analyst)" list="alert-keyword-list" autocomplete="off">
                    <datalist id="alert-keyword-list"></datalist>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" name="company" id="alert-company" placeholder="Company (optional)" list="alert-company-list" autocomplete="off">
                    <datalist id="alert-company-list"></datalist>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" name="location" id="alert-location" placeholder="Location (optional)" list="alert-location-list" autocomplete="off">
                    <datalist id="alert-location-list"></datalist>
                </div>
            </div>
            <button type="submit" class="btn btn-career btn-sm mt-3"><i class="bi bi-plus me-1"></i>Add Alert</button>
        </form>
    </div>

    <!-- Active Alerts -->
    <h6 class="fw-bold mb-3" style="color: var(--dark);">Your Alerts</h6>
    {% if alerts %}
    <div class="d-flex flex-column gap-2 mb-4">
        {% for alert in alerts %}
        <div class="stat-card py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge me-1" style="background: var(--primary); color: #fff;">{{ alert.keyword or '-' }}</span>
                    {% if alert.company %}<span class="badge me-1 bg-primary-soft" style="color: var(--primary);">{{ alert.company }}</span>{% endif %}
                    {% if alert.location %}<span class="badge" style="background: var(--gray); color: #fff;">{{ alert.location }}</span>{% endif %}
                </div>
                <form method="POST" action="{{ url_for('delete_job_alert', alert_id=alert.id) }}">
                    <button type="submit" class="btn btn-sm" style="background: var(--danger); color: #fff; border-radius: 8px; font-size: 0.8rem;"><i class="bi bi-trash"></i></button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state py-3 mb-4">
        <i class="bi bi-bell-slash d-block" style="font-size: 2rem;"></i>
        <p class="mb-0">No job alerts set up</p>
    </div>
    {% endif %}

    <!-- Suggested Jobs -->
    {% if suggested_jobs_by_alert %}
    <h6 class="fw-bold mb-3" style="color: var(--dark);"><i class="bi bi-stars me-1" style="color: var(--warning);"></i>Suggested Jobs for Your Alerts</h6>
    <div class="row g-3">
        {% for item in suggested_jobs_by_alert.values() %}
        {% set alert = item.alert %}
        {% set jobs = item.jobs %}
        <div class="col-md-6">
            <div class="stat-card">
                <div class="mb-2">
                    <span class="badge" style="background: var(--primary); color: #fff;">{{ alert.keyword or '-' }}</span>
                    {% if alert.company %}<span class="badge ms-1 bg-primary-soft" style="color: var(--primary);">{{ alert.company }}</span>{% endif %}
                    {% if alert.location %}<span class="badge ms-1" style="background: var(--gray); color: #fff;">{{ alert.location }}</span>{% endif %}
                </div>
                {% if jobs %}
                <div class="d-flex flex-column gap-2">
                    {% for job in jobs %}
                    <div class="p-2 rounded-3" style="background: rgba(67,97,238,0.04);">
                        <div class="fw-bold" style="color: var(--dark); font-size: 0.9rem;">{{ job.title }}</div>
                        <div style="font-size: 0.83rem; color: var(--gray);">{{ job.company }} | {{ job.location }}</div>
                        <div style="font-size: 0.83rem; color: var(--gray);">{{ job.job_type or 'N/A' }} | {{ job.salary or 'N/A' }}</div>
                        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="btn btn-career-outline btn-sm mt-1" style="font-size: 0.78rem;"><i class="bi bi-eye me-1"></i>View</a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0" style="font-size: 0.85rem;">No matching jobs found</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
function setupAutocomplete(inputId, datalistId, endpoint) {
    const input = document.getElementById(inputId);
    const datalist = document.getElementById(datalistId);
    let lastQuery = '';
    input.addEventListener('input', function() {
        const q = this.value.trim();
        if (q.length < 1 || q === lastQuery) return;
        lastQuery = q;
        fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
            .then(res => res.json())
            .then(data => {
                datalist.innerHTML = '';
                data.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    datalist.appendChild(option);
                });
            });
    });
}
setupAutocomplete('alert-keyword', 'alert-keyword-list', '/autocomplete_job_titles');
setupAutocomplete('alert-company', 'alert-company-list', '/autocomplete_companies');
setupAutocomplete('alert-location', 'alert-location-list', '/autocomplete_locations');
</script>
{% endblock %}
